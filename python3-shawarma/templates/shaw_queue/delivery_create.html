{% extends "shaw_queue/base.html" %}
<title>Меню</title>
{% block aditional_static %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'queue/loader.css' %}">
    <script type="text/javascript" src="{% static 'js/menu_handlers.js' %}"></script>
{% endblock %}
{% block content %}
    <div style="margin-left: 50px; margin-top: 20px">
        <div id="ymap" style="width: 100%; height: 400px; width: 560px"></div>

        <br>
        <br>
        <p>Адрес</p>
        <input type="text" value="" class="live-search-box" id="address" style="width: 550px;">
        <input id="coordinate_input" disabled value="61.326502 55.17317">
        <input id="delivery_price" disabled value="цена доставки: "><br>
        <button class="small-btn" onclick="getCoordinate()">ОК</button>
        <br>
        <br>
        <p>Номер квартиры</p>
        <input type="text" value="" class="live-search-box" id="room" style="width: 550px;">
        <br>
        <p>Комментарий</p>
        <input type="text" value="" class="live-search-box" id="comment" style="width: 550px;">
        <br>
        <br>
        <p>Телефон</p>
        <input type="text" value="" placeholder="+7..." class="live-search-box" id="phone" style="width: 550px;">
        <br>
        <button type="button" class="small-btn success" onclick="SMS()">
            отправить СМС
        </button>

        <script src="https://api-maps.yandex.ru/2.1/?apikey={{ geocoder_key }}&lang=ru_RU" type="text/javascript"></script>
        <script>
            function SMS() {
                alert('СМС не отправилось')
            }

            let delivery_price = $('#delivery_price');

            function getCoordinate(coords=null) {

                let address = $('#address');
                let coordinate_input = $('#coordinate_input');
                $.ajax({
                    url: "https://geocode-maps.yandex.ru/1.x/?apikey={{ geocoder_key }}&format=json&geocode=Челябинск, " + address.val() + "&results=1",
                    type: "GET",
                    success: function (data) {
                        if (data.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.results === 0) {
                            alert('Нет результатов')
                        }
                        {#console.log(data.response)#}
                        let coordinates
                        if (coords) {
                            coordinates = coords
                            coordinate_input.val([coords[0].toFixed(6), coords[1].toFixed(6)].join(' '))
                        } else {
                            coordinates = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos
                            coordinate_input.val(coordinates)
                            coordinates = coordinates.split(' ', 2)
                        }
                        changePosition(coordinates, address.val())
                    },
                    error: function (xhr, errmsg, err) {
                        alert("Что-то не так: " + errmsg);
                    }
                });
            }

            ymaps.ready(init);
            let myMap
            let myPlacemark
            let zoom = 11
            let duration = 700
            let limit_positions = 15
            let doZoom = true
            let distance

            let multiRoute

            function init() {
                myMap = new ymaps.Map("ymap", {
                    center: [55.1540200, 61.3891500],
                    zoom: zoom
                }, {
                    searchControlProvider: 'yandex#search'
                });

                let centerPlacemark = new ymaps.Placemark([55.168280, 61.386348], {
                    iconCaption: ''
                }, {
                    preset: 'islands#nightIcon'
                });
                myMap.geoObjects.add(centerPlacemark);


                myMap.events.add('click', function (e) {
                    var coords = e.get('coords');
                    doZoom = false
                    getCoordinate([coords[1], coords[0]])
                });
            }

            function changePosition(coordinates, description) {
                get_distance([55.168280, 61.386348], coordinates)

                if (limit_positions === 0) {
                    alert('лимит запросов')
                    return
                }
                coordinates = [parseFloat(coordinates[1]), parseFloat(coordinates[0])]
                myMap.geoObjects.remove(myPlacemark)
                myPlacemark = new ymaps.Placemark(coordinates, {
                    iconCaption: description
                }, {
                    preset: 'islands#greenStretchyIcon'
                });
                myMap.geoObjects.add(myPlacemark);
                if(doZoom) {
                    myMap.setZoom(zoom, {duration: duration});
                }
                setTimeout(() => {
                    myMap.panTo(coordinates, {duration: 700})
                }, duration);

                setTimeout(() => {
                    myMap.setCenter(coordinates)
                    if(doZoom) {
                        myMap.setZoom(15, {duration: 700});
                        limit_positions = limit_positions - 1;
                    }
                    zoom = 13
                    duration = 300
                    doZoom = true
                }, duration + 700);

                setTimeout(() => {
                    delivery_price.val('цена доставки: ' + get_price(distance) + '₽  км: ' +  (distance/1000).toFixed(1))
                }, 1000);

            }

            function get_distance(coordinates1, coordinates2) {
                myMap.geoObjects.remove(multiRoute);
                multiRoute = new ymaps.multiRouter.MultiRoute({
                    referencePoints: [
                        coordinates1,
                        [coordinates2[1], coordinates2[0]]
                    ]
                }, {
                    boundsAutoApply: true
                });

                // Добавление маршрута на карту.
                myMap.geoObjects.add(multiRoute);
                // Подписка на событие обновления данных маршрута.
                multiRoute.model.events.add('requestsuccess', function() {
                    // Получение ссылки на активный маршрут.
                    // В примере используется автомобильный маршрут,
                    // поэтому метод getActiveRoute() вернет объект multiRouter.driving.Route.
                    var activeRoute = multiRoute.getActiveRoute();
                    // Вывод информации о маршруте.
                    distance = activeRoute.properties.get("distance").value
                    console.log("Длина: " + distance);
                    console.log("Время прохождения: " + activeRoute.properties.get("duration").text);
                });
                // Добавление маршрута на карту.
                myMap.geoObjects.add(multiRoute);
                return distance
            }

            function get_price(value) {
                {{ delivery_js|safe }}
            }

        </script>
        <br>
        <br>
        <a class="small-btn" href="/shaw_queue/menu/">назад</a>
    </div>
{% endblock %}
