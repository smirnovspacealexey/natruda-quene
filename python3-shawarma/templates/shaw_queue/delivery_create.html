{% extends "shaw_queue/base.html" %}
<title>–ú–µ–Ω—é</title>
{% block aditional_static %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'queue/loader.css' %}">
    <script type="text/javascript" src="{% static 'js/menu_handlers.js' %}"></script>
    <script src="{% static 'js/jquery.maskedinput.js' %}" type="text/javascript"></script>
    <script type="text/javascript" src="{% static 'js/jquery.cookie.js' %}"></script>

    <style>
        @import url(https://fonts.googleapis.com/css?family=Montserrat:400,700);

        html {
            font-family: 'Montserrat', Arial, sans-serif;
            -ms-text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
        }

        body {
            background: #F2F3EB;
        }

        button {
            overflow: visible;
        }

        button, select {
            text-transform: none;
        }

        button, input, select, textarea {
            color: #5A5A5A;
            font: inherit;
            margin: 0;
        }

        input {
            line-height: normal;
        }

        textarea {
            overflow: auto;
        }

        #container {
            border: solid 3px #474544;
            max-width: 768px;
            margin: 60px auto;
            position: relative;
        }

        .form {
            padding: 37.5px;
            margin: 50px 0;
        }

        h1 {
            color: #474544;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 7px;
            text-align: center;
            text-transform: uppercase;
        }
        .icon_wrapper {
            margin: 50px auto 0;
            width: 100%;
        }

        .icon {
            display: block;
            fill: #474544;
            height: 50px;
            margin: 0 auto;
            width: 50px;
        }

        input[type='text'], input[type='tel'], select, textarea {
            background: none;
            border: none;
            border-bottom: solid 2px #474544;
            color: #474544;
            font-size: 1.000em;
            font-weight: 400;
            letter-spacing: 1px;
            margin: 0em 0 1.875em 0;
            padding: 0 0 0.875em 0;
            text-transform: uppercase;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            -ms-box-sizing: border-box;
            -o-box-sizing: border-box;
            box-sizing: border-box;
            -webkit-transition: all 0.3s;
            -moz-transition: all 0.3s;
            -ms-transition: all 0.3s;
            -o-transition: all 0.3s;
            transition: all 0.3s;
        }

        input[type='text']:focus, input[type='tel']:focus, textarea:focus {
            outline: none;
            padding: 0 0 0.875em 0;
        }

        .comment {
            float: none;
        }

        .right45 {
            float: right;
            width: 45%;
        }

        .left45 {
            float: left;
            width: 45%;
        }

        .right15 {
            float: right;
            width: 15%;
        }

        .left75 {
            float: left;
            width: 75%;
        }

        .left20 {
            float: left;
            width: 20%;
        }


        select {
            background: url('https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-ios7-arrow-down-32.png') no-repeat right;
            outline: none;
            -moz-appearance: none;
            -webkit-appearance: none;
        }

        select::-ms-expand {
            display: none;
        }

        .subject {
            width: 100%;
        }

        textarea {
            line-height: 150%;
            height: 50px;
            resize: none;
            width: 100%;
        }

        ::-webkit-input-placeholder {
            color: #474544;
        }

        :-moz-placeholder {
            color: #474544;
            opacity: 1;
        }

        ::-moz-placeholder {
            color: #474544;
            opacity: 1;
        }

        :-ms-input-placeholder {
            color: #474544;
        }

        .form_button {
            background: none;
            border: solid 2px #474544;
            color: #474544;
            cursor: pointer;
            display: inline-block;
            font-family: 'Helvetica', Arial, sans-serif;
            font-size: 0.875em;
            font-weight: bold;
            outline: none;
            padding: 20px 35px;
            text-transform: uppercase;
            -webkit-transition: all 0.3s;
            -moz-transition: all 0.3s;
            -ms-transition: all 0.3s;
            -o-transition: all 0.3s;
            transition: all 0.3s;
        }

        .form_button:hover {
            background: #474544;
            color: #F2F3EB;
        }

        @media screen and (max-width: 768px) {
            #container {
                margin: 20px auto;
                width: 95%;
            }
        }

        @media screen and (max-width: 480px) {
            h1 {
                font-size: 26px;
            }

            .underline {
                width: 68px;
            }

            .form_button {
                padding: 10px 20px;
            }
        }

        @media screen and (max-width: 420px) {
            h1 {
                font-size: 18px;
            }

            .icon {
                height: 35px;
                width: 35px;
            }

            .underline {
                width: 53px;
            }

            input[type='text'], [type='email'], select, textarea {
                font-size: 0.875em;
            }
        }
    </style>
{% endblock %}
{% block content %}
    <div id="container">
        <div id="ymap" style="width: 100%; height: 400px; width: 760px"></div>

        <h1>üåØ –§–æ—Ä–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ ü•£</h1>
        <div class="underline">
        </div>


        <div class="icon_wrapper">
            <svg class="icon" viewBox="0 0 145.192 145.192">
                <path d="M126.82,32.694c-2.804,0-5.08,2.273-5.08,5.075v2.721c-1.462,0-2.646,1.185-2.646,2.647v1.995    c0,1.585,1.286,2.873,2.874,2.873h20.577c1.462,0,2.646-1.185,2.646-2.647v-3.041c0-1.009-0.816-1.825-1.823-1.825v-2.722    c0-2.802-2.276-5.075-5.079-5.075h-1.985v-3.829c0-3.816-3.095-6.912-6.913-6.912h-0.589h-20.45c0-2.67-2.164-4.835-4.833-4.835    H56.843c-2.67,0-4.835,2.165-4.835,4.835H34.356v-3.384h-9.563v3.384v1.178h-7.061v1.416c-2.67,0.27-10.17,1.424-13.882,5.972    c-1.773,2.17-2.44,4.791-1.983,7.793c0.463,3.043,1.271,6.346,2.128,9.841c2.354,9.616,5.024,20.515,0.549,28.077    C2.647,79.44-3.125,90.589,2.201,99.547c4.123,6.935,13.701,10.44,28.5,10.44c1.186,0,2.405-0.023,3.658-0.068v9.028h-0.296    c-2.516,0-4.558,2.039-4.558,4.558v4.566h100.04v-4.564c0-2.519-2.039-4.558-4.558-4.558h-0.297V84.631h0.297    c2.519,0,4.558-2.037,4.558-4.556v-0.009c0-2.516-2.039-4.556-4.556-4.556l-36.786-0.009V61.973c0-2.193-1.777-3.971-3.972-3.971    v-4.711h0.456c1.629,0,2.952-1.32,2.952-2.949h14.227V34.459h1.658c2.672,0,4.834-2.165,4.834-4.834h20.45v3.069H126.82z     M34.06,75.511c-2.518,0-4.558,2.04-4.558,4.556v0.009c0,2.519,2.042,4.556,4.558,4.556h0.296v24.12l-0.042-1.168    c-15.994,0.574-26.122-2.523-30.106-9.229C-0.464,90.5,4.822,80.347,6.55,77.423c4.964-8.382,2.173-19.774-0.29-29.825    c-0.843-3.442-1.639-6.696-2.088-9.638c-0.354-2.35,0.129-4.3,1.484-5.958c3.029-3.714,9.509-4.805,12.076-5.1v1.233h7.061v1.49    v2.684c-2.403,1.114-4.153,2.997-4.676,5.237H18.15c-0.584,0-1.056,0.474-1.056,1.056v0.83c0,0.584,0.475,1.056,1.056,1.056h1.984    c0.561,2.18,2.304,3.999,4.658,5.092v0.029c0,0-2.282,20.823,16.479,22.099v1.102c0,1.177,0.955,2.133,2.133,2.133h3.297    c1.178,0,2.133-0.956,2.133-2.133V50.135c0-1.177-0.955-2.132-2.133-2.132h-3.297c-1.178,0-2.133,0.955-2.133,2.132    c-1.575-0.235-5.532-1.17-6.635-4.547c2.36-1.092,4.109-2.913,4.669-5.097h1.308c0.722,0,1.309-0.584,1.309-1.308v-0.578    c0-0.584-0.475-1.056-1.056-1.056h-1.539c-0.542-2.332-2.416-4.271-4.968-5.363v-2.559h17.651c0,2.67,2.166,4.835,4.836,4.835 h2.392v15.88h13.639c0,1.629,1.321,2.949,2.951,2.949h0.899v4.711c-2.194,0-3.972,1.778-3.972,3.971v13.529L34.06,75.511z     M95.188,101.78c0,8.655-7.012,15.665-15.664,15.665c-8.653,0-15.667-7.01-15.667-15.665c0-8.647,7.014-15.664,15.667-15.664    C88.177,86.116,95.188,93.132,95.188,101.78z M97.189,45.669h-9.556c0-0.896-0.726-1.62-1.619-1.62H74.494    c-0.896,0-1.621,0.727-1.621,1.62h-8.967v-11.21h33.283V45.669z"></path>
                <path d="M70.865,101.78c0,4.774,3.886,8.657,8.66,8.657c4.774,0,8.657-3.883,8.657-8.657c0-4.773-3.883-8.656-8.657-8.656    C74.751,93.124,70.865,97.006,70.865,101.78z"></path>
            </svg>
        </div>

        <div class="right45">
            <input id="delivery_price" disabled="" value="—Ü–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: 0‚ÇΩ –∫–º: 0" style="width: 400px">
            <input id="full_price" disabled="" value="–æ–±—â–∞—è —Ü–µ–Ω–∞ –∑–∞ –∑–∞–∫–∞–∑: {{ order_price }}‚ÇΩ">
        </div>

        <div class="form">
            <input disabled="" value="* - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è" style="margin-bottom: 50px">
            <div class="fullname left75">
                <label for="fullname"></label>
                <input type="text" placeholder="*–£–ª–∏—Ü–∞, –¥–æ–º" name="fullname" id="fullname" style="width: 100%">
            </div>
            <div class="right15">
                <button class="form_button" onclick="getCoordinate()">–Ω–∞ –∫–∞—Ä—Ç–µ</button>
                <input id="coordinate_input" style="font-size: 0.7rem;" disabled="" value="61.32650 55.17317">
            </div>

            <div style="margin-top: 80px">
                <div class="left20">
                    <input type="text" placeholder="–ü–æ–¥—ä–µ–∑–¥" name="porch" id="porch" style="width: 70%">
                </div>
                <div class="left20">
                    <input type="text" placeholder="–î–æ–º–æ—Ñ–æ–Ω" name="door_code" id="door_code" style="width: 70%">
                </div>
                <div class="left20">
                    <input type="text" placeholder="–≠—Ç–∞–∂" name="sfloor" id="sfloor" style="width: 70%">
                </div>
                <div class="left20">
                    <input type="text" placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞" name="sflat" id="sflat" style="width: 70%">
                </div>
            </div>

            <div class="comment" style="margin-top: 200px">
                <label for="comment"></label>
                <textarea name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫—É—Ä—å–µ—Ä–∞" id="comment"></textarea>
            </div>

            <div class="left45">
                <input type="tel" title="–¢–µ–ª–µ—Ñ–æ–Ω" placeholder="*–¢–µ–ª–µ—Ñ–æ–Ω" name="phone" id="phone">
            </div>

            <div class="right45">
                <input type="text" placeholder="–ò–º—è" name="name" id="name">
            </div>
            {#            <div class="subject">#}
            {#                <label for="subject"></label>#}
            {#                <select placeholder="Subject line" name="subject" id="subject_input">#}
            {#                    <option disabled hidden selected>Subject line</option>#}
            {#                    <option>I'd like to start a project</option>#}
            {#                    <option>I'd like to ask a question</option>#}
            {#                    <option>I'd like to make a proposal</option>#}
            {#                </select>#}
            {#            </div>#}

            <div style="margin-top: 100px">
                <div class="left45">
                    <a class="form_button" href="/shaw_queue/menu/" onclick="addDataToCookie()">–Ω–∞–∑–∞–¥</a>
                </div>

                <button style="padding: 30px" class="form_button" onclick="SMS()">
                    <h1>üì©</h1>
                    <br>
                    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –°–ú–° –Ω–∞ –æ–ø–ª–∞—Ç—É
                </button>
            </div>

        </div>
    </div>



    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ geocoder_key }}&lang=ru_RU" type="text/javascript"></script>
    <script>
        function addDataToCookie() {
            if (save_data_to_storage) {
                sessionStorage.setItem('deliveryData', JSON.stringify(data));
            }
        }

        function SMS() {
            if (data['phone'] === null) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω!')
            } else if (data['fullname'] === null) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —É–ª–∏—Ü—É –∏ –¥–æ–º!')
            } else if (data['coordinates'] === null) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ!')
            } else if (data['full_price'] === null) {
                alert('–ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫( \n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É')
            } else if (data['delivery_price'] === null) {
                alert('–ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫( \n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É')
            } else if (data['pk_delivery'] === null) {
                alert('–ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫( \n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É')
            } else {
                $.ajax({
                    type: 'POST',
                    url: '{% url 'api-delivery-sms' %}',
                    data: data,
                    dataType: 'json',
                    success: function (res) {
                        $.cookie('is_delivery','true', { path: '/' });
                        $.cookie('daily_number',res['daily_number'], { path: '/' });
                        save_data_to_storage = false
                        sessionStorage.removeItem('deliveryData')

                        let cookieCurrOrder = $.cookie('currOrder');
                        let resCurrOrder = eval(cookieCurrOrder);
                        resCurrOrder.push({
                            'id': res['pk'],
                            'title': res['title'],
                            'price': res['price'],
                            'quantity': res['quantity'],
                            'note': res['note'],
                        })
                        cookieCurrOrder = JSON.stringify(resCurrOrder);
                        $.cookie('currOrder', cookieCurrOrder, { path: '/' });
                        alert('–°–ú–° —É—à–ª–∞')
                    },
                    error: function (xhr, errmsg, err) {
                        alert('–°–ú–° –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å')
                    }
                });
            }

        }

        let data = {
            'delivery_price': null,
            'full_price': null,
            'fullname': null,
            'coordinates': null,
            'porch': null,
            'door_code': null,
            'sfloor': null,
            'sflat': null,
            'comment': null,
            'phone': null,
            'name': null,
            'pk_delivery': null,
        }

        let save_data_to_storage = true;
        let delivery_price = $('#delivery_price');
        let full_price = $('#full_price');

        $('#name').change(function() {
            data['name'] = $(this).val()
        });
        $('#phone').change(function() {
            data['phone'] = $(this).val()
        });
        $('#comment').change(function() {
            data['comment'] = $(this).val()
        });
        $('#porch').change(function() {
            data['porch'] = $(this).val()
        });
        $('#sflat').change(function() {
            data['sflat'] = $(this).val()
        });
        $('#sfloor').change(function() {
            data['sfloor'] = $(this).val()
        });
        $('#door_code').change(function() {
            data['door_code'] = $(this).val()
        });
        $('#fullname').change(function() {
            data['fullname'] = $(this).val()
        });


        $(document).ready(function () {
            $("#phone").mask("+7(999)999-99-99");
            let deliveryData = JSON.parse(sessionStorage.getItem('deliveryData'));
            if (deliveryData) {
                data = deliveryData
                for (key in data) {
                    $('#' + key).val(data[key])
                }
                $('#coordinate_input').val([data['coordinates'][0].toFixed(6), data['coordinates'][1].toFixed(6)].join(' '))
            }
        })

        function getCoordinate(coords=null) {
            window.scrollTo({
                top: 0,
                left: 0,
                behavior: 'smooth'
            });
            let fullname = $('#fullname');
            let coordinate_input = $('#coordinate_input');
            $.ajax({
                url: "https://geocode-maps.yandex.ru/1.x/?apikey={{ geocoder_key }}&format=json&geocode=–ß–µ–ª—è–±–∏–Ω—Å–∫, " + fullname.val() + "&results=1",
                type: "GET",
                success: function (data) {
                    if (data.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.results === 0) {
                        alert('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤')
                    }
                    {#console.log(data.response)#}
                    let coordinates
                    if (coords) {
                        coordinates = coords
                        coordinate_input.val([coords[0].toFixed(6), coords[1].toFixed(6)].join(' '))
                    } else {
                        coordinates = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos
                        coordinate_input.val(coordinates)
                        coordinates = coordinates.split(' ', 2)
                    }
                    changePosition(coordinates)
                },
                error: function (xhr, errmsg, err) {
                    alert("–ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫: " + errmsg);
                }
            });
        }

        ymaps.ready(init);
        let myMap
        let myPlacemark
        let multiRoute

        let zoom = 11
        let duration = 700
        let limit_positions = 15
        let doZoom = true
        let distance

        let order_price = {{ order_price }}

            function init() {
                myMap = new ymaps.Map("ymap", {
                    center: [55.1540200, 61.3891500],
                    zoom: zoom
                }, {
                    searchControlProvider: 'yandex#search'
                });

                let centerPlacemark = new ymaps.Placemark([55.168280, 61.386348], {
                    iconContent: 'üåØ',

                }, {
                    preset: 'islands#darkOrangeIcon',
                });
                myMap.geoObjects.add(centerPlacemark);


                myMap.events.add('click', function (e) {
                    var coords = e.get('coords');
                    doZoom = false
                    getCoordinate([coords[1], coords[0]])
                });
            }

        function changePosition(coordinates) {
            data['coordinates'] = coordinates
            get_distance([55.168280, 61.386348], coordinates)

            if (limit_positions === 0) {
                alert('–ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤')
                return
            }
            coordinates = [parseFloat(coordinates[1]), parseFloat(coordinates[0])]
            myMap.geoObjects.remove(myPlacemark)
            myPlacemark = new ymaps.Placemark(coordinates, {
                iconContent: 'ü•£',
            }, {
                preset: 'islands#greenIcon'
            });

            myMap.geoObjects.add(myPlacemark);
            if(doZoom) {
                myMap.setZoom(zoom, {duration: duration});
            }
            setTimeout(() => {
                myMap.panTo(coordinates, {duration: 700})
            }, duration);

            setTimeout(() => {
                myMap.setCenter(coordinates)
                if(doZoom) {
                    myMap.setZoom(15, {duration: 700});
                    limit_positions = limit_positions - 1;
                }
                zoom = 13
                duration = 300
                doZoom = true
            }, duration + 700);

            setTimeout(() => {
                let res_distance_price = get_price(distance)
                let res_full_price = res_distance_price + order_price
                delivery_price.val('—Ü–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: ' + res_distance_price + '‚ÇΩ  –∫–º: ' +  (distance/1000).toFixed(1))
                full_price.val('–æ–±—â–∞—è —Ü–µ–Ω–∞ –∑–∞ –∑–∞–∫–∞–∑: ' + res_full_price + '‚ÇΩ')
                data['full_price'] = res_full_price
                data['delivery_price'] = res_distance_price
            }, 1000);

        }

        function get_distance(coordinates1, coordinates2) {
            myMap.geoObjects.remove(multiRoute);
            multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [
                    coordinates1,
                    [coordinates2[1], coordinates2[0]]
                ]
            }, {
                wayPointVisible: false,
                boundsAutoApply: false
            });

            multiRoute.model.events.add('requestsuccess', function() {
                var activeRoute = multiRoute.getActiveRoute();
                distance = activeRoute.properties.get("distance").value
                console.log("–î–ª–∏–Ω–∞: " + distance);
                console.log("–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è: " + activeRoute.properties.get("duration").text);
            });
            myMap.geoObjects.add(multiRoute);
        }

        function get_price(value) {
            {{ delivery_js|safe }}
        }
    </script>

{% endblock %}
